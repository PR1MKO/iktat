{% extends 'base.html' %}
{% import 'includes/case_macros.html' as cm %}

{% block title %}Investigation {{ investigation.case_number }}{% endblock %}

{% block content %}
<h1>{{ investigation.case_number }}</h1>

<div class="card mb-3">
  <div class="card-header">Details</div>
  <div class="card-body">
    <table class="table table-sm mb-0">
      <tr><th scope="row">Case number</th><td>{{ investigation.case_number }}</td></tr>
      <tr><th scope="row">Investigation type</th><td>{{ investigation.investigation_type or '–' }}</td></tr>
      <tr><th scope="row">Subject name</th><td>{{ investigation.subject_name }}</td></tr>
      <tr><th scope="row">Mother's name</th><td>{{ investigation.mother_name }}</td></tr>
      <tr><th scope="row">Birth place</th><td>{{ investigation.birth_place }}</td></tr>
      <tr><th scope="row">Birth date</th><td>{{ investigation.birth_date }}</td></tr>
      <tr><th scope="row">TAJ number</th><td>{{ investigation.taj_number }}</td></tr>
      <tr><th scope="row">Residence</th><td>{{ investigation.residence }}</td></tr>
      <tr><th scope="row">Citizenship</th><td>{{ investigation.citizenship }}</td></tr>
      <tr><th scope="row">Institution</th><td>{{ investigation.institution_name }}</td></tr>
      <tr><th scope="row">Registration time</th><td>{{ investigation.registration_time_str }}</td></tr>
      <tr><th scope="row">Deadline</th><td>{{ investigation.deadline_str or '–' }}</td></tr>
      <tr><th scope="row">Assignment type</th><td>{{ investigation.assignment_type }}</td></tr>
        <tr><th scope="row">Assigned expert</th><td>{{ user_display_name(assigned_expert) }}</td></tr>
    </table>
  </div>
</div>

<div class="card mb-3">
  <div class="card-header">Uploaded files</div>
  <ul class="list-group list-group-flush">
    {% for a in attachments %}
      <li class="list-group-item d-flex flex-wrap justify-content-between align-items-center">
        <span class="flex-grow-1 text-break">
          <a class="text-break" href="{{ url_for('investigations.download_investigation_file', inv_id=investigation.id, file_id=a.id) }}">{{ a.filename }}</a>
          <small class="text-muted">({{ a.category }})</small>
        </span>
        <small class="text-muted text-nowrap">{{ a.uploaded_at_str }}</small>
      </li>
    {% else %}
      <li class="list-group-item text-muted">No files uploaded.</li>
    {% endfor %}
  </ul>
</div>

<div class="card mb-3">
  <div class="card-header">Notes</div>
  <div class="card-body">
    {% set can_post_inv_note = caps.get('can_post_investigation_notes_effective', caps.get('can_post_investigation_notes')) %}
    {% if can_post_inv_note %}
    <div class="mb-3">
      <textarea id="note-text" class="form-control" rows="3"></textarea>
      <button type="button" id="add-note-btn" class="btn btn-secondary mt-2">Add</button>
    </div>
    {% endif %}
    <ul id="notes" class="list-group">
      {% for note in notes %}
        {% set author = note.author %}
        {% include 'investigations/_note.html' %}
      {% endfor %}
    </ul>
  </div>
</div>

<div class="mt-3">
  {{ cm.changelog_block(changelog_entries) }}
</div>

<script>
  document.getElementById('add-note-btn')?.addEventListener('click', function() {
    const txt = document.getElementById('note-text');
    if (!txt.value.trim()) {
      txt.classList.add('is-invalid');
      return;
    }
    fetch('{{ url_for('investigations.add_investigation_note', id=investigation.id) }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify({text: txt.value.trim()})
    })
    .then(r => { if (!r.ok) throw new Error(); return r.text(); })
    .then(html => {
      document.getElementById('notes').insertAdjacentHTML('afterbegin', html);
      txt.value = '';
    })
    .catch(() => alert('Error saving note'));
  });
</script>
{% endblock %}
