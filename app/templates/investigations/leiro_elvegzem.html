{% extends "base.html" %}
{% block title %}Leíró – Elvégzem ({{ investigation.case_number or investigation.id }}){% endblock %}
{% block content %}
<div class="container py-3">
  <h1 class="visually-hidden">Leíró — Vizsgálat munkalap</h1>
  {% include "investigations/_adatok_card.html" %}
  
  <div class="card mb-3">
    <div class="card-header fw-bold">Dokumentum generátor</div>
    <div class="card-body d-grid gap-2 d-sm-block">
      <a
        href="{{ url_for('investigations.leiro_ertesites_form', id=investigation.id) }}"
        class="btn btn-outline-primary"
      >
        <i class="bi bi-file-earmark-word"></i> Értesítés szakértői vizsgálatról
      </a>
      <a
        href="{{ url_for('investigations.leiro_tajekoztatas_arajanlat', id=investigation.id) }}"
        class="btn btn-outline-primary"
      >
        <i class="bi bi-file-earmark-word"></i> Tájékoztatás árajánlat
      </a>
      <a
        href="{{ url_for('investigations.leiro_dokumentum_bekerese', id=investigation.id) }}"
        class="btn btn-outline-primary"
      >
        <i class="bi bi-file-earmark-word"></i> Dokumentumok bekérése
      </a>
      <a
        href="{{ url_for('investigations.leiro_szakkonzultansi_nyilatkozat', id=investigation.id) }}"
        class="btn btn-outline-primary"
      >
        <i class="bi bi-file-earmark-word"></i> Szakkonzultánsi nyilatkozat
      </a>
      <a
        href="{{ url_for('investigations.leiro_tajekoztatas_ugy_szignalasarol', id=investigation.id) }}"
        class="btn btn-outline-primary"
      >
        <i class="bi bi-file-earmark-word"></i> Tájékoztatás ügy szignálásáról
      </a>
      <a
        href="{{ url_for('investigations.leiro_szakerto_szakkonzultans_bevonasa', id=investigation.id) }}"
        class="btn btn-outline-primary"
      >
        <i class="bi bi-file-earmark-word"></i> Szakértő / szakkonzultáns bevonása
      </a>
      <a
        href="{{ url_for('investigations.leiro_hatarido_hosszabbitas_kerelem', id=investigation.id) }}"
        class="btn btn-outline-primary"
      >
        <i class="bi bi-file-earmark-word"></i> Határidő hosszabbítás kérelem
      </a>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
      <span>Dokumentumok</span>
      {% if not can_upload_ui %}
      <span class="badge bg-secondary">Feltöltés letiltva</span>
      {% endif %}
    </div>
    <div class="card-body">
      {% if can_upload_ui %}
      <form id="file-upload-form"
            class="file-upload-form needs-validation d-flex align-items-center flex-wrap gap-2"
            method="post"
            enctype="multipart/form-data"
            action="{{ url_for('investigations.upload_investigation_file', id=investigation.id) }}">
        {{ upload_form.hidden_tag() }}
        <label for="file" class="form-label me-2 visually-hidden">Fájl feltöltése</label>
        <input type="file"
               id="file"
               name="file"
               class="form-control"
               multiple
               required
               aria-label="Fájl feltöltése"
               title="Fájl feltöltése">
        <select name="category"
                id="upload-category-file-upload-form"
                class="form-select category-select"
                required
                aria-describedby="category-help-file-upload-form">
          <option value="" disabled selected hidden>-- Válasszon kategóriát --</option>
          {% for val, label in upload_form.category.choices %}
          <option value="{{ val }}">{{ label }}</option>
          {% endfor %}
        </select>
        <div id="category-help-file-upload-form"
             class="invalid-feedback category-warning d-none"
             role="alert">
          Kategória megadása kötelező.
        </div>
        <button type="submit" class="btn btn-outline-success upload-btn" disabled>Feltöltés</button>
      </form>
      {% else %}
      <div class="alert alert-info mb-3" role="alert">
        {{ cannot_upload_reason or "Nincs jogosultság a feltöltéshez." }}
      </div>
      {% endif %}

      <div class="mt-4">
        {% if attachments and attachments|length %}
        <div class="list-group">
          {% for att in attachments %}
          <div class="list-group-item d-flex flex-wrap justify-content-between align-items-center">
            <div class="flex-grow-1 text-break">
              <div class="fw-semibold text-break">{{ att.filename }}</div>
              <div class="small text-muted">{{ att.category }} • {{ att.uploaded_at_str }}</div>
            </div>
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('investigations.download_investigation_file', inv_id=investigation.id, file_id=att.id) }}">Letöltés</a>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-muted">Nincs csatolt dokumentum.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="card mb-3" id="notes-form">
    <div class="card-header fw-bold">Megjegyzések</div>
    <div class="card-body">
      {% set can_post_inv_note = caps.get('can_post_investigation_notes_effective', caps.get('can_post_investigation_notes')) %}
        <ul id="notes-list" class="list-group list-group-flush mb-3 notes-scroll">
        {% if notes and notes|length %}
          {% for note in notes %}
            {% set author = note.author %}
            {% include 'investigations/_note.html' %}
          {% endfor %}
        {% else %}
          <li class="list-group-item text-muted empty-state">Nincsenek megjegyzések.</li>
        {% endif %}
      </ul>
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      {% if can_post_inv_note %}
      <textarea name="text" class="form-control mb-2" rows="2" aria-label="Új megjegyzés"></textarea>
      <button type="button"
              id="add-note-btn"
              class="btn btn-primary"
              data-notes-url="{{ url_for('investigations.add_investigation_note', id=investigation.id) }}">
        Hozzáadás
      </button>
      {% endif %}
    </div>
  </div>

  <div class="card mb-5">
    <div class="card-header fw-bold">Változások</div>
    <div class="card-body">
      {% if changelog and changelog|length %}
      <div class="list-group">
        {% for log in changelog %}
        <div class="list-group-item">
          <div class="small text-muted">{{ user_display_name(log.editor) }} • {{ log.timestamp_str }}</div>
          <div><strong>{{ log.field_name }}</strong>: {{ log.old_value }} → {{ log.new_value }}</div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="text-muted">Nincs változás.</div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script nonce="{{ csp_nonce }}" src="{{ url_for('static', filename='js/investigations_documents.js') }}" defer></script>
  <script nonce="{{ csp_nonce }}" type="module" src="{{ url_for('static', filename='js/investigation_detail.js') }}"></script>
{% endblock %}