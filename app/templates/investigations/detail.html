{% extends 'base.html' %}
{% block title %}Vizsgálat {{ investigation.case_number or investigation.id }}{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="card mb-4">
    <div class="card-header">Adatok</div>
    <div class="card-body">
      <table class="table table-borderless mb-0">
        <tr>
          <td><strong>ID:</strong> {{ investigation.id }}</td>
          <td><strong>Ügyiratszám:</strong> {{ investigation.case_number or '–' }}</td>
        </tr>
        <tr>
          <td><strong>Alany neve:</strong> {{ investigation.subject_name }}</td>
          <td><strong>Regisztrálva:</strong> {{ investigation.registration_time_str }}</td>
        </tr>
        <tr>
          <td colspan="2"><strong>Határidő:</strong> {{ investigation.deadline_str }}</td>
        </tr>
      </table>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">Dokumentumok</div>
    <div class="card-body">
      {% if caps['can_upload_investigation'] %}
      <form id="upload-form" class="mb-3" enctype="multipart/form-data" action="{{ url_for('investigations.upload_investigation_file', id=investigation.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {{ upload_form.category(class='form-select d-inline w-auto') }}
        {{ upload_form.file(class='form-control d-inline w-auto') }}
        <button type="button" id="upload-btn" class="btn btn-secondary">Feltöltés</button>
      </form>
      {% endif %}
      <div id="attachments">
        {% if attachments %}
        <ul class="list-group list-group-flush mb-0">
          {% for att in attachments %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              {{ att.filename }}
              <span class="badge bg-secondary ms-2">{{ att.category }}</span>
            </div>
            <div class="text-nowrap">
              <small class="text-muted">{{ att.uploaded_at_str }}</small>
              <a href="{{ url_for('investigations.download_investigation_file', inv_id=investigation.id, file_id=att.id) }}" class="btn btn-sm btn-outline-primary ms-2">Letöltés</a>
            </div>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <div class="text-muted empty-state">Nincs feltöltött fájl.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">Megjegyzések</div>
    <div class="card-body">
      <ul id="notes-list" class="list-group list-group-flush mb-3">
        {% if notes %}
          {% for note in notes %}
            {% set author = note.author %}
            {% include 'investigations/_note.html' %}
          {% endfor %}
        {% else %}
          <li class="list-group-item text-muted empty-state">Nincsenek megjegyzések.</li>
        {% endif %}
      </ul>
      {% if caps['can_post_investigation_notes'] %}
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <textarea name="text" class="form-control mb-2" rows="2"></textarea>
      <button type="button" id="add-note-btn" class="btn btn-primary">Hozzáadás</button>
      {% endif %}
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">Változások</div>
    <div class="card-body">
      {% if changelog %}
      <ul class="list-group list-group-flush mb-0">
        {% for log in changelog %}
        <li class="list-group-item">
          {{ log.timestamp_str }} – {{ user_display_name(log.editor) }} – {{ log.field_name }}: {{ log.old_value }} → {{ log.new_value }}
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <div class="text-muted">Nincsenek változások.</div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/investigation_upload.js') }}"></script>
<script src="{{ url_for('static', filename='js/investigation_detail.js') }}"></script>
{% endblock %}
