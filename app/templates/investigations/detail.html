{% extends 'base.html' %}
{% block title %}Vizsgálat {{ investigation.case_number or investigation.id }}{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="card mb-4">
    <div class="card-header">Adatok</div>
    <div class="card-body p-0">
      {% set _exec_map = {
        'INTEZETI': 'Intézeti',
        'intézeti': 'Intézeti',
        'intezeti': 'Intézeti',
        'Intézeti': 'Intézeti',
        'SZAKÉRTŐI': 'Szakértői',
        'szakértői': 'Szakértői',
        'szakertoi': 'Szakértői',
        'Szakértői': 'Szakértői'
      } %}
      <div class="container-fluid py-2">
        <div class="row g-2 mb-2">
          <div class="col-12 col-md-3">
            <div class="small text-muted fw-semibold">Ügyszám</div>
            <div>{{ investigation.case_number or investigation.id }}</div>
          </div>
          <div class="col-12 col-md-3">
            <div class="small text-muted fw-semibold">Végrehajtás módja</div>
            <div>{{ assignment_type_label or _exec_map.get(investigation.assignment_type, investigation.assignment_type or '–') }}</div>
          </div>
          <div class="col-12 col-md-3">
            <div class="small text-muted fw-semibold">Szakértő</div>
            <div>{{ expert_display_name }}</div>
          </div>
          <div class="col-12 col-md-3">
            <div class="small text-muted fw-semibold">Leíró</div>
            <div>{{ describer_display_name }}</div>
          </div>
        </div>

        <div class="row g-2 mb-2">
          <div class="col-12 col-md-3">
            <div class="small text-muted fw-semibold">Vizsgálat típusa</div>
            <div>{{ investigation_type_label or '–' }}</div>
          </div>
          <div class="col-12 col-md-3">
            <div class="small text-muted fw-semibold">Külső ügyirat szám</div>
            <div>{{ investigation.external_case_number or '–' }}</div>
          </div>
          <div class="col-12 col-md-3">
            <div class="small text-muted fw-semibold">Egyéb azonosító</div>
            <div>{{ investigation.other_identifier or '–' }}</div>
          </div>
          <div class="col-12 col-md-3">
            <div class="small text-muted fw-semibold">Vizsgált személy neve</div>
            <div>{{ investigation.subject_name or '–' }}</div>
          </div>
        </div>

        <div class="row g-2 mb-2">
          <div class="col-12 col-md-3">
            <div class="small text-muted fw-semibold">Beküldő intézmény</div>
            <div>{{ investigation.institution_name or '–' }}</div>
          </div>
          <div class="col-12 col-md-3">
            <div class="small text-muted fw-semibold">Leánykori neve</div>
            <div>{{ investigation.maiden_name or '–' }}</div>
          </div>
          <div class="col-12 col-md-3">
            <div class="small text-muted fw-semibold">Anyja neve</div>
            <div>{{ investigation.mother_name or '–' }}</div>
          </div>
          <div class="col-12 col-md-3">
            <div class="small text-muted fw-semibold">TAJ szám</div>
            <div>{{ investigation.taj_number or '–' }}</div>
          </div>
        <div class="row g-2">
          <div class="col-12 col-md-4">
            <div class="small text-muted fw-semibold">Állampolgársága</div>
            <div>{{ investigation.citizenship or '–' }}</div>
          </div>
          <div class="col-12 col-md-4">
            <div class="small text-muted fw-semibold">Születési hely</div>
            <div>{{ investigation.birth_place or '–' }}</div>
          </div>
          <div class="col-12 col-md-4">
            <div class="small text-muted fw-semibold">Születési idő</div>
            <div>{{ investigation.birth_date_str or '–' }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">Dokumentumok</div>
    <div class="card-body">
      {% if can_upload_ui %}
      <form id="file-upload-form"
            action="{{ url_for('investigations.upload_investigation_file', id=investigation.id) }}"
            method="post"
            enctype="multipart/form-data"
            class="needs-validation d-flex align-items-center file-upload-form">
        {{ upload_form.hidden_tag() }}
        <label for="file" class="form-label me-2 visually-hidden">Fájl feltöltése</label>
        <input type="file" id="file" name="file" class="form-control me-2" multiple required aria-label="Fájl feltöltése" title="Fájl feltöltése">
        <select name="category" id="upload-category-file-upload-form" class="form-select me-2 category-select" required aria-invalid="false" aria-describedby="category-help-file-upload-form">
          <option value="" disabled selected hidden>-- Válasszon kategóriát --</option>
          {% for val, label in upload_form.category.choices %}
            <option value="{{ val }}">{{ label }}</option>
          {% endfor %}
        </select>
        <div id="category-help-file-upload-form" class="invalid-feedback category-warning d-none" role="alert">
          Kategória megadása kötelező.
        </div>
        <button type="submit" class="btn btn-outline-success upload-btn" disabled>Feltöltés</button>
      </form>
      {% else %}
      <div class="alert alert-info mb-3" role="alert">
        {{ cannot_upload_reason or "Nincs jogosultság a feltöltéshez." }}
      </div>
      {% endif %}
      <div id="attachments">
        {% if attachments %}
        <ul class="list-group list-group-flush mb-0">
          {% for att in attachments %}
          <li class="list-group-item d-flex flex-wrap justify-content-between align-items-center">
            <div class="flex-grow-1 text-break">
              {{ att.filename }}
              <span class="badge bg-secondary ms-2">{{ att.category }}</span>
            </div>
            <div class="text-nowrap">
              <small class="text-muted">{{ att.uploaded_at_str }}</small>
              <a href="{{ url_for('investigations.download_investigation_file', inv_id=investigation.id, file_id=att.id) }}" class="btn btn-sm btn-outline-primary ms-2">Letöltés</a>
            </div>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <div class="text-muted empty-state">Nincs feltöltött fájl.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="card mb-4" id="notes-form">
    <div class="card-header">Megjegyzések</div>
    <div class="card-body">
      {% set can_post_inv_note = caps.get('can_post_investigation_notes_effective', caps.get('can_post_investigation_notes')) %}
      <ul id="notes-list" class="list-group list-group-flush mb-3">
        {% if notes %}
          {% for note in notes %}
            {% set author = note.author %}
            {% include 'investigations/_note.html' %}
          {% endfor %}
        {% else %}
          <li class="list-group-item text-muted empty-state">Nincsenek megjegyzések.</li>
        {% endif %}
      </ul>
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      {% if can_post_inv_note %}
      <textarea name="text" class="form-control mb-2" rows="2"></textarea>
      <button type="button"
              id="add-note-btn"
              class="btn btn-primary"
              data-notes-url="{{ url_for('investigations.add_investigation_note', id=investigation.id) }}">Hozzáadás</button>
      {% endif %}
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">Változások</div>
    <div class="card-body">
      {% if changelog %}
      <ul class="list-group list-group-flush mb-0">
        {% for log in changelog %}
        <li class="list-group-item">
          {{ log.timestamp_str }} – {{ user_display_name(log.editor) }} – {{ log.field_name }}: {{ log.old_value }} → {{ log.new_value }}
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <div class="text-muted">Nincsenek változások.</div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script nonce="{{ csp_nonce }}" type="module" src="{{ url_for('static', filename='js/investigation_detail.js') }}"></script>
{% endblock %}
