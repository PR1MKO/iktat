{% extends 'base.html' %}
{% block title %}Vizsgálat {{ investigation.case_number or investigation.id }}{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="card mb-4">
    <div class="card-header">Adatok</div>
    <div class="card-body p-0">
      {% set _exec_map = {
        'INTEZETI': 'Intézeti',
        'intézeti': 'Intézeti',
        'intezeti': 'Intézeti',
        'Intézeti': 'Intézeti',
        'SZAKÉRTŐI': 'Szakértői',
        'szakértői': 'Szakértői',
        'szakertoi': 'Szakértői',
        'Szakértői': 'Szakértői'
      } %}
      <div class="container-fluid py-2">
        <!-- Row 1: Ügyszám | Végrehajtás módja | Szakértő -->
        <div class="row g-3">
          <div class="col-12 col-lg-4">
            <div class="text-muted small">Ügyszám</div>
            <div>{{ investigation.case_number or investigation.id }}</div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="text-muted small">Végrehajtás módja</div>
            <div>{{ assignment_type_label or _exec_map.get(investigation.assignment_type, investigation.assignment_type or '–') }}</div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="text-muted small">Szakértő</div>
            <div>{{ assigned_expert_display or '–' }}</div>
          </div>
        </div>

        <!-- Row 2: Vizsgálat típusa | Külső ügyirat szám | Egyéb azonosító (4/4/4) -->
        <div class="row g-3 mt-1">
          <div class="col-12 col-lg-4">
            <div class="text-muted small">Vizsgálat típusa</div>
            <div>{{ investigation_type_label or '–' }}</div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="text-muted small">Külső ügyirat szám</div>
            <div>{{ investigation.external_case_number or '–' }}</div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="text-muted small">Egyéb azonosító</div>
            <div>{{ investigation.other_identifier or '–' }}</div>
          </div>
        </div>

        <!-- Row 3: Vizsgált személy neve (left) | Beküldő intézmény (6/6) -->
        <div class="row g-3 mt-1">
          <div class="col-12 col-lg-6">
            <div class="text-muted small">Vizsgált személy neve</div>
            <div>{{ investigation.subject_name or '–' }}</div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="text-muted small">Beküldő intézmény</div>
            <div>{{ investigation.institution_name or '–' }}</div>
          </div>
        </div>

        <!-- Row 4: Leánykori neve | Anyja neve | TAJ szám (4/4/4) -->
        <div class="row g-3 mt-1">
          <div class="col-12 col-lg-4">
            <div class="text-muted small">Leánykori neve</div>
            <div>{{ investigation.maiden_name or '–' }}</div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="text-muted small">Anyja neve</div>
            <div>{{ investigation.mother_name or '–' }}</div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="text-muted small">TAJ szám</div>
            <div>{{ investigation.taj_number or '–' }}</div>
          </div>
        </div>

        <!-- Row 5: Születési hely | Születési idő (6/6) -->
        <div class="row g-3 mt-1">
          <div class="col-12 col-lg-6">
            <div class="text-muted small">Születési hely</div>
            <div>{{ investigation.birth_place or '–' }}</div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="text-muted small">Születési idő</div>
            <div>{{ investigation.birth_date_str or '–' }}</div>
          </div>
        </div>

        <!-- Row 6: Lakcíme | Állampolgársága (6/6) -->
        <div class="row g-3 mt-1">
          <div class="col-12 col-lg-6">
            <div class="text-muted small">Lakcíme</div>
            <div>{{ investigation.residence or '–' }}</div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="text-muted small">Állampolgársága</div>
            <div>{{ investigation.citizenship or '–' }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">Dokumentumok</div>
    <div class="card-body">
      {% if caps['can_upload_investigation'] %}
      <form id="upload-form" class="mb-3" enctype="multipart/form-data" action="{{ url_for('investigations.upload_investigation_file', id=investigation.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {{ upload_form.category(class='form-select d-inline w-auto') }}
        {{ upload_form.file(class='form-control d-inline w-auto') }}
        <button type="button" id="upload-btn" class="btn btn-secondary">Feltöltés</button>
      </form>
      {% endif %}
      <div id="attachments">
        {% if attachments %}
        <ul class="list-group list-group-flush mb-0">
          {% for att in attachments %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              {{ att.filename }}
              <span class="badge bg-secondary ms-2">{{ att.category }}</span>
            </div>
            <div class="text-nowrap">
              <small class="text-muted">{{ att.uploaded_at_str }}</small>
              <a href="{{ url_for('investigations.download_investigation_file', inv_id=investigation.id, file_id=att.id) }}" class="btn btn-sm btn-outline-primary ms-2">Letöltés</a>
            </div>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <div class="text-muted empty-state">Nincs feltöltött fájl.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">Megjegyzések</div>
    <div class="card-body">
      <ul id="notes-list" class="list-group list-group-flush mb-3">
        {% if notes %}
          {% for note in notes %}
            {% set author = note.author %}
            {% include 'investigations/_note.html' %}
          {% endfor %}
        {% else %}
          <li class="list-group-item text-muted empty-state">Nincsenek megjegyzések.</li>
        {% endif %}
      </ul>
      {% if caps['can_post_investigation_notes'] %}
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <textarea name="text" class="form-control mb-2" rows="2"></textarea>
      <button type="button" id="add-note-btn" class="btn btn-primary">Hozzáadás</button>
      {% endif %}
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">Változások</div>
    <div class="card-body">
      {% if changelog %}
      <ul class="list-group list-group-flush mb-0">
        {% for log in changelog %}
        <li class="list-group-item">
          {{ log.timestamp_str }} – {{ user_display_name(log.editor) }} – {{ log.field_name }}: {{ log.old_value }} → {{ log.new_value }}
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <div class="text-muted">Nincsenek változások.</div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/investigation_upload.js') }}"></script>
<script src="{{ url_for('static', filename='js/investigation_detail.js') }}"></script>
{% endblock %}
