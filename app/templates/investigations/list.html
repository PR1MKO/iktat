{% extends 'base.html' %}
{% block title %}Vizsgálatok{% endblock %}
{% block content %}
<div class="card-body d-flex align-items-center py-3">
  <div>
    <h3 class="h4 mb-0">Vizsgálatok</h3>
  </div>
</div>

<form method="get" action="{{ url_for('investigations.list_investigations') }}" class="row g-3 mb-4">
  <div class="col-md-5">
    <input type="text" class="form-control" name="search"
           value="{{ search_query or request.args.get('q','') }}" placeholder="Keresés...">
  </div>
  <div class="col-md-3">
    <select class="form-select" name="case_type">
      <option value="">Típus (mind)</option>
      <option value="hatósági"     {% if case_type_filter=='hatósági' %}selected{% endif %}>hatósági</option>
      <option value="klinikai"     {% if case_type_filter=='klinikai' %}selected{% endif %}>klinikai</option>
      <option value="igazságügyi"  {% if case_type_filter=='igazságügyi' %}selected{% endif %}>igazságügyi</option>
      <option value="kórboncolási" {% if case_type_filter=='kórboncolási' %}selected{% endif %}>kórboncolási</option>
      <option value="elengedés"    {% if case_type_filter=='elengedés' %}selected{% endif %}>elengedés</option>
    </select>
  </div>
  <div class="col-md-2">
    <button type="submit" class="btn btn-primary w-100">Szűrés</button>
  </div>
  <div class="col-md-2">
    <a href="{{ url_for('investigations.list_investigations') }}" class="btn btn-outline-secondary w-100">Törlés</a>
  </div>
</form>

{% set params = query_params or request.args.to_dict() %}
{% set next_order = 'desc' if params.get('sort_order','asc') == 'asc' else 'asc' %}
<div class="card shadow-sm mb-4">
  <div class="table-responsive">
    <table class="table table-bordered align-middle mb-0">
      <thead class="table-light">
        <tr class="fw-bold text-secondary">
          <th>
            {% set p = params.copy() %}
            {% set _ = p.update({'sort_by':'case_number','sort_order': next_order if params.get('sort_by')=='case_number' else 'asc'}) %}
            <a href="{{ url_for(request.endpoint, **p) }}">
              Vizsgálat szám
              {% if params.get('sort_by') == 'case_number' %}{{ '▲' if params.get('sort_order')=='asc' else '▼' }}{% endif %}
            </a>
          </th>
          <th>Vizsgált neve</th>
          <th>Típus</th>
          <th>Intézmény</th>
          <th>Regisztrálva</th>
          <th>
            {% set p = params.copy() %}
            {% set _ = p.update({'sort_by':'deadline','sort_order': next_order if params.get('sort_by')=='deadline' else 'asc'}) %}
            <a href="{{ url_for(request.endpoint, **p) }}">
              Határidő
              {% if params.get('sort_by') == 'deadline' %}{{ '▲' if params.get('sort_order')=='asc' else '▼' }}{% endif %}
            </a>
          </th>
          <th>Szakértő 1</th>
          <th>Szakértő 2</th>
          <th>Leíró</th>
          <th class="text-end">Részletek</th>
        </tr>
      </thead>
      <tbody>
        {% for inv in investigations %}
        <tr>
          <td><a href="{{ url_for('investigations.detail_investigation', id=inv.id) }}">{{ inv.case_number }}</a></td>
          <td>{{ inv.subject_name }}</td>
          <td>{{ inv.investigation_type }}</td>
          <td>{{ inv.institution_name }}</td>
          <td>{{ inv.registration_time_str }}</td>
          <td>{{ inv.deadline_str }}</td>
          <td>{{ inv.expert1_name }}</td>
          <td>{{ inv.expert2_name }}</td>
          <td>{{ inv.describer_name }}</td>
          <td class="text-end">
            {% if current_user.role == 'iroda' %}
              {# If an edit route exists, use it; else fall back to detail #}
              {% if 'investigations.edit_investigation' in current_app.view_functions %}
                <a href="{{ url_for('investigations.edit_investigation', id=inv.id) }}" class="btn btn-sm btn-primary">Szerkeszt</a>
              {% else %}
                <a href="{{ url_for('investigations.detail_investigation', id=inv.id) }}" class="btn btn-sm btn-primary">Szerkeszt</a>
              {% endif %}
            {% else %}
              <a href="{{ url_for('investigations.detail_investigation', id=inv.id) }}" class="btn btn-sm btn-secondary">Megtekintés</a>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="10" class="text-center">Nincs megjeleníthető vizsgálat.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% if pagination and pagination.pages > 1 %}
<nav aria-label="Oldal navigáció">
  <ul class="pagination justify-content-center">
    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
      {% set p = params.copy() %}
      {% set _ = p.update({'page': pagination.prev_num}) %}
      <a class="page-link" href="{{ url_for('investigations.list_investigations', **p) }}" aria-label="Előző">
        <span aria-hidden="true">&laquo;</span>
      </a>
    </li>
    {% for pnum in range(1, pagination.pages + 1) %}
    <li class="page-item {% if pnum == pagination.page %}active{% endif %}">
      {% set p = params.copy() %}
      {% set _ = p.update({'page': pnum}) %}
      <a class="page-link" href="{{ url_for('investigations.list_investigations', **p) }}">{{ pnum }}</a>
    </li>
    {% endfor %}
    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
      {% set p = params.copy() %}
      {% set _ = p.update({'page': pagination.next_num}) %}
      <a class="page-link" href="{{ url_for('investigations.list_investigations', **p) }}" aria-label="Következő">
        <span aria-hidden="true">&raquo;</span>
      </a>
    </li>
  </ul>
</nav>
{% endif %}
{% endblock %}