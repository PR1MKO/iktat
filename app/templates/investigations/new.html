{# app/templates/investigations/new.html #}
{% extends "base.html" %}
{% block title %}Új vizsgálat{% endblock %}

{% block content %}
<div class="container mt-3">
  <h3>Új vizsgálat</h3>

  {# flash messages (errors from form/route) #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ 'danger' if category in ('error','danger') else category }} mb-2" role="alert">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <form method="post" novalidate>
    {{ form.csrf_token }}

    <!-- Row 1: assignment type, expert, investigation type -->
    <div class="row mb-3">
      <div class="col-md-4">
        <label class="form-label d-block">{{ form.assignment_type.label }}</label>
        <div class="form-check form-check-inline">
          <input
            class="form-check-input"
            type="radio"
            id="assignment_type-intezeti"
            name="assignment_type"
            value="INTEZETI"
            {% if form.assignment_type.data == 'INTEZETI' or not form.assignment_type.data %}checked{% endif %}
          >
          <label class="form-check-label" for="assignment_type-intezeti">Intézeti</label>
        </div>
        <div class="form-check form-check-inline">
          <input
            class="form-check-input"
            type="radio"
            id="assignment_type-szakertoi"
            name="assignment_type"
            value="SZAKÉRTŐI"
            {% if form.assignment_type.data == 'SZAKÉRTŐI' %}checked{% endif %}
          >
          <label class="form-check-label" for="assignment_type-szakertoi">Szakértői</label>
        </div>
        {% for e in form.assignment_type.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
      </div>

      <div class="col-md-4">
        <label class="form-label" for="assigned_expert_id">{{ form.assigned_expert_id.label }}</label>
        <select
          class="form-select"
          id="assigned_expert_id"
          name="assigned_expert_id"
          {% if form.assignment_type.data != 'SZAKÉRTŐI' %}disabled{% endif %}
          {% if form.assignment_type.data == 'SZAKÉRTŐI' %}required{% endif %}
        >
          {% for val, label in form.assigned_expert_id.choices %}
            <option value="{{ val }}" {% if form.assigned_expert_id.data == val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
        {% for e in form.assigned_expert_id.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
      </div>

      <div class="col-md-4">
        <label class="form-label">{{ form.investigation_type.label }}</label>
        {{ form.investigation_type(class="form-select", required=True) }}
        {% for e in form.investigation_type.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
      </div>
    </div>

    <!-- Row 2: external case number, other identifier, institution name -->
    <div class="row mb-3">
      <div class="col-md-4">
        <label class="form-label">{{ form.external_case_number.label }}</label>
        {{ form.external_case_number(class="form-control") }}
        {% for e in form.external_case_number.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-4">
        <label class="form-label">{{ form.other_identifier.label }}</label>
        {{ form.other_identifier(class="form-control") }}
        {% for e in form.other_identifier.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-4">
        <label class="form-label">{{ form.institution_name.label }}</label>
        {{ form.institution_name(class="form-control", required=True) }}
        {% for e in form.institution_name.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
      </div>
    </div>

    <!-- Row 3: subject name, maiden name, mother name -->
    <div class="row mb-3">
      <div class="col-md-4">
        <label class="form-label">{{ form.subject_name.label }}</label>
        {{ form.subject_name(class="form-control", required=True) }}
        {% for e in form.subject_name.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-4">
        <label class="form-label">{{ form.maiden_name.label }}</label>
        {{ form.maiden_name(class="form-control") }}
        {% for e in form.maiden_name.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-4">
        <label class="form-label">{{ form.mother_name.label }}</label>
        {{ form.mother_name(class="form-control", required=True) }}
        {% for e in form.mother_name.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
      </div>
    </div>

    <!-- Row 4: birth place, birth date, taj number -->
    <div class="row mb-3">
      <div class="col-md-4">
        <label class="form-label">{{ form.birth_place.label }}</label>
        {{ form.birth_place(class="form-control", required=True) }}
        {% for e in form.birth_place.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-4">
        <label class="form-label">{{ form.birth_date.label }}</label>
        {{ form.birth_date(class="form-control", type="date", required=True) }}
        {% for e in form.birth_date.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-4">
        <label class="form-label">{{ form.taj_number.label }}</label>
        {{ form.taj_number(class="form-control", required=True) }}
        {% for e in form.taj_number.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
      </div>
    </div>

    <!-- Row 5: residence and citizenship -->
    <div class="row mb-4">
      <div class="col-md-8">
        <label class="form-label">{{ form.residence.label }}</label>
        {{ form.residence(class="form-control", required=True) }}
        {% for e in form.residence.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-4">
        <label class="form-label">{{ form.citizenship.label }}</label>
        {{ form.citizenship(class="form-control", required=True) }}
        {% for e in form.citizenship.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
      </div>
    </div>

    <div class="d-flex gap-2">
      {{ form.submit(class="btn btn-primary") }}
      <a href="{{ url_for('investigations.list_investigations') }}" class="btn btn-secondary">Mégse</a>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/investigations_toggle.js') }}" defer nonce="{{ csp_nonce }}"></script>
{% endblock %}
