{# templates/includes/case_macros.html #}

{% if caps is not defined %}
  {% set caps = {
    'can_view_cases': False,
    'can_view_investigations': False,
    'can_edit_case': False,
    'can_upload_case': False,
    'can_assign': False,
    'can_change_status': False,
    'can_post_notes': False,
    'can_download_files': False,
    'can_edit_investigation': False,
    'can_upload_investigation': False,
    'can_post_investigation_notes': False,
  } %}
{% endif %}

{% macro alapadatok(case) %}
<!-- Adatok (merged Alapadatok + További adatok) -->
<div class="card">
  <div class="card-header fw-bold">Adatok</div>
  <div class="card-body">
    <table class="table table-borderless mb-0">
      {% set explicit_describer = (case.describer | default('', true)) | trim %}
      {% set fallback_describer = (effective_describer | default('', true)) | trim %}
      <tr>
        <td><strong>Boncszám:</strong> {{ case.case_number }}</td>
        <td><strong>Elhunyt neve:</strong> {{ case.deceased_name }}</td>
        <td><strong>Elhunyt lánykori neve:</strong> {{ case.lanykori_nev or '–' }}</td>
        <td><strong>Elhunyt lakhelye:</strong> {{ case.residence or '–' }}</td>
      </tr>
      <tr>
        <td><strong>Anyja neve:</strong> {{ case.mother_name or '–' }}</td>
        <td><strong>Születési hely:</strong> {{ case.szul_hely or '–' }}</td>
        <td><strong>Születési idő:</strong> {{ fmt_date(case.birth_date) if case.birth_date else '–' }}</td>
        <td><strong>TAJ szám:</strong> {{ case.taj_szam or '–' }}</td>
      </tr>
      <tr>
        <td><strong>Állampolgársága:</strong> {{ case.citizenship or '–' }}</td>
        <td colspan="2"><strong>Intézmény:</strong> {{ case.institution_name or '–' }}</td>
        <td><strong>Poszeidon:</strong> {{ case.poszeidon or '–' }}</td>
      </tr>
      <tr>
        <td><strong>Típus:</strong> {{ case.case_type }}</td>
        <td><strong>Beérkezés módja:</strong> {{ case.beerk_modja or '–' }}</td>
        <td><strong>Külső ügyirat szám:</strong> {{ case.external_case_number or '–' }}</td>
        <td><strong>Egyéb azonosító:</strong> {{ case.temp_id or '–' }}</td>
      </tr>
        {# Show registration and deadline dates with hidden time to keep full datetime in the DOM #}
        <tr>
          <td><strong>Állapot:</strong> {{ case.status }}</td>
          <td>
            <strong>Regisztrálva:</strong>
              {{ case.registration_time_str or '–' }}
            </td>
            <td colspan="2">
              <strong>Határidő:</strong>
              {{ case.deadline_str or '–' }}
            </td>
          </tr>
      <tr>
        <td><strong>Szakértő 1:</strong> {{ case.expert_1 or '–' }}</td>
        <td><strong>Szakértő 2:</strong> {{ case.expert_2 or '–' }}</td>
        <td colspan="2"><strong>Leíró:</strong> {{ fallback_describer or explicit_describer or '–' }}</td>
      </tr>
    </table>
  </div>
</div>
{% endmacro %}

{% macro uploaded_files(case) %}
<div class="card h-100">
  <div class="card-header">Feltöltött fájlok</div>
  <div class="card-body">
    {% if case.uploaded_file_records %}
      <ul class="list-group list-group-flush mb-0">
        {% for rec in case.uploaded_file_records %}
          <li class="list-group-item d-flex flex-wrap justify-content-between align-items-center gap-2">
            <div class="d-flex align-items-center gap-2 flex-wrap flex-grow-1 text-break">
              <a class="text-break" href="{{ url_for('auth.download_file', case_id=case.id, filename=rec.filename) }}">
                {{ rec.filename }}
              </a>
              {% if rec.category %}
                <span class="badge bg-secondary">{{ rec.category }}</span>
              {% endif %}
            </div>
            <small class="text-muted text-nowrap">
              {{ rec.uploader }}{% if rec.upload_time_str %} · {{ rec.upload_time_str }}{% endif %}
            </small>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="text-muted p-3">Nincs feltöltött fájl.</div>
    {% endif %}
  </div>
</div>
{% endmacro %}

{% macro notes_block(case) %}
<div class="card flex-fill d-flex flex-column h-100">
  <div class="card-header">Jegyzetek</div>
  <div class="card-body flex-fill overflow-auto p-3">
      <div id="notes-list" class="notes-list notes-scroll">
      {% if case.notes %}
          {% for line in case.notes.split('\n') %}
          <div class="alert alert-secondary py-2" data-auto-dismiss="false">{{ line }}</div>
        {% endfor %}
      {% else %}
        <div class="text-muted fst-italic" data-notes-empty>Nincsenek megjegyzések.</div>
      {% endif %}
    </div>

    <label for="new_note" class="form-label visually-hidden">Új megjegyzés</label>
    <textarea id="new_note" name="new_note"
              class="form-control mb-2"
              rows="2"
              aria-label="Új megjegyzés"
              placeholder="Új megjegyzés..."></textarea>
    {% if caps['can_post_notes'] %}
    <button type="button" id="add_note_btn" class="btn btn-primary">Hozzáadás</button>
    {% endif %}
  </div>
</div>
{% endmacro %}

{% macro changelog_block(changelog_entries) %}
<div class="card flex-fill d-flex flex-column h-100">
  <div class="card-header">Változásnapló</div>
  <div class="card-body flex-fill overflow-auto p-3">
    {% if changelog_entries %}
      <ul class="list-group list-group-flush mb-0">
        {% for entry in changelog_entries %}
          <li class="list-group-item py-2">
            {% if entry.field_name == 'tox_orders' %}
              {% set parsed = entry.new_value | parse_tox_changelog %}
              {% if parsed %}
                <span class="text-muted small">{{ parsed.ts }} — {{ parsed.user }}</span> {{ parsed.name }} rendelve
              {% else %}
                <span class="text-muted small">{{ (entry.timestamp_str|default('')) or fmt_budapest(entry.timestamp, "%Y/%m/%d %H:%M") }} — {{ entry.edited_by }}</span> {{ entry.new_value or '–' }}
              {% endif %}
            {% elif entry.field_name == 'notes' %}
              {% set parsed = entry.new_value | parse_note_changelog %}
              {% if parsed %}
                <span class="text-muted small">{{ parsed.ts }} — {{ parsed.user }}</span> {{ parsed.text }}
              {% else %}
                {{ entry.new_value or '–' }}
              {% endif %}
            {% else %}
              <span class="text-muted small">{{ (entry.timestamp_str|default('')) or fmt_budapest(entry.timestamp, "%Y/%m/%d %H:%M") }} — {{ entry.edited_by }}</span> {{ entry.new_value or '–' }}
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="text-center text-muted p-3">Nincs rögzített változás.</div>
    {% endif %}
  </div>
</div>
{% endmacro %}

{# File upload block with accessible labeling #}
{% macro file_upload_block(upload_url=None, input_name='result_file', form_id='file-upload-form', multiple=False, label='Fájl feltöltése', btn_label='Feltöltés', extra_fields={}, categories=None, case_id=None, extra_inline=None) %}
{# Prefer explicit upload_url; otherwise build from case_id #}
<form id="{{ form_id }}"
      action="{{ upload_url or url_for('auth.upload_file', case_id=case_id) }}"
      method="post"
      enctype="multipart/form-data"
      class="needs-validation d-flex align-items-center flex-md-nowrap flex-wrap w-100 gap-3 file-upload-form">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  {% for name, value in extra_fields.items() %}
    <input type="hidden" name="{{ name }}" value="{{ value }}">
  {% endfor %}
  <label for="{{ input_name }}" class="form-label me-2 visually-hidden">{{ label }}</label>
  <input type="file"
         id="{{ input_name }}"
         name="{{ input_name }}"
         class="form-control flex-grow-1"
         style="min-width:0"
         {% if multiple %}multiple{% endif %}
         required
         aria-label="{{ label }}"
         title="{{ label }}">
  {% set default_categories = [
        ('végzés', 'Végzés'),
        ('jegyzőkönyv', 'Jegyzőkönyv'),
        ('egyéb', 'Egyéb')
     ] %}
  {% if categories is not none %}
    {% set options = categories %}
  {% elif cat_options is defined %}
    {% set options = cat_options %}
  {% else %}
    {% set options = default_categories %}
  {% endif %}
  <select name="category"
    id="upload-category-{{ form_id or 'file-upload-form' }}"
    class="form-select category-select w-auto flex-shrink-0"
    required
    aria-invalid="false"
    aria-describedby="category-help-{{ form_id or 'file-upload-form' }}"
  >
    <option value="" disabled selected hidden>-- Válasszon kategóriát --</option>
    {% for c in options %}
      {% if c.__class__.__name__ in ['list', 'tuple'] %}
        <option value="{{ c[0] }}">{{ c[1] }}</option>
      {% else %}
        <option value="{{ c }}">{{ c }}</option>
      {% endif %}
    {% endfor %}
  </select>
  <div
    id="category-help-{{ form_id or 'file-upload-form' }}"
    class="invalid-feedback category-warning d-none"
    role="alert"
    aria-hidden="true"
  ></div>
  {% if extra_inline %}
  <span class="d-inline-flex align-items-center gap-2 flex-shrink-0 upload-inline">{{ extra_inline|safe }}</span>
  {% endif %}
  {% if caps['can_upload_case'] %}
  <button type="submit" class="btn btn-outline-success upload-btn flex-shrink-0" disabled>{{ btn_label }}</button>
  {% endif %}
</form>
{% endmacro %}

{% macro select_block(select_id, name, options, label='Válasszon', placeholder='Válasszon...', selected=None, required=False) %}
<label for="{{ select_id }}" class="form-label">{{ label }}</label>
<select id="{{ select_id }}"
        name="{{ name }}"
        class="form-select"
        aria-label="{{ label }}"
        title="{{ label }}"
        {% if required %}required{% endif %}>
  {% for value, text in options %}
    <option value="{{ value }}" {% if selected == value %}selected{% endif %}>{{ text }}</option>
  {% endfor %}
</select>
{% endmacro %}

{% macro orders_block(tox_orders) %}
<div class="card h-100">
  <div class="card-header">Elrendelt vizsgálatok</div>
  <div class="card-body p-0">
    {% if tox_orders %}
      <table class="table mb-0">
        <tbody>
          {% for line in tox_orders.strip().split('\n') %}
            {% set parts = line.split(': ',1) %}
            {% set name = parts[0] %}
            {% set rest = parts[1].split(' – ',1) %}
            <tr>
              <td>{{ name }}</td>
              <td>{{ rest[0] }}</td>
              <td>{{ rest|length>1 and rest[1] or '–' }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="p-3 text-muted">Nincsenek elrendelt vizsgálatok.</div>
    {% endif %}
  </div>
</div>
{% endmacro %}

{% macro notes_ajax_block(case) %}
<div class="col-md-6 d-flex flex-column" id="notes-form">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  {{ notes_block(case) }}
</div>

<!-- inline script removed; now loaded from static -->
{% endmacro %}

{% macro cases_filter_form(search_query='', case_type_filter='', status_filter='') %}
<form method="get" action="{{ url_for('auth.list_cases') }}" class="row g-3 mb-4">
  <div class="col-md-3">
    <label for="search" class="form-label">Keress bármire</label>
    <input type="text"
           class="form-control"
           id="search"
           name="search"
           value="{{ search_query }}"
           aria-label="Keresés"
           title="Keresés"
           placeholder="Keresés...">
  </div>
  <div class="col-md-3">
    {{ select_block(
      'case_type',
      'case_type',
      [
        ('', 'Mind'),
        ('hatósági', 'hatósági'),
        ('klinikai', 'klinikai'),
        ('igazságügyi', 'igazságügyi'),
        ('kórboncolási', 'kórboncolási'),
        ('elengedés', 'elengedés')
      ],
      'Típus szerint',
      'Mind',
      selected=case_type_filter if case_type_filter else ''
    ) }}
  </div>

  <div class="col-md-3">
    {{ select_block(
      'status',
      'status',
      [
        ('', 'Mind'),
        ('beérkezett', 'beérkezett'),
        ('boncolva-leírónál', 'boncolva-leírónál'),
        ('boncolva-orvosnál', 'boncolva-orvosnál'),
        ('leiktatva', 'leiktatva'),
        ('szignálva', 'szignálva'),
        ('lezárt', 'lezárt'),
        ('rendőrségre küldve', 'rendőrségre küldve'),
        ('számla megérkezett', 'számla megérkezett'),
        ('postafakkba', 'postafakkba')
      ],
      'Állapot szerint',
      'Mind',
      selected=status_filter if status_filter else ''
    ) }}
  </div>

  <div class="col-md-3 d-flex align-items-end">
    <button type="submit" class="btn btn-primary me-2">Szűrés</button>
    <a href="{{ url_for('auth.list_cases') }}" class="btn btn-outline-secondary">Törlés</a>
  </div>
</form>
{% endmacro %}

{# Macro to build query string from params dict #}
{% macro query_string(params) %}
  {%- if params -%}
    ?{%- for k, v in params.items() -%}
      {{ k }}={{ v }}{% if not loop.last %}&{% endif %}
    {%- endfor -%}
  {%- else -%}
    ''
  {%- endif -%}
{% endmacro %}

{% macro cases_table(cases, users_map=None, sort_by='', sort_order='', query_params={}, show_actions=True) %}
{% set _users_map = users_map or {} %}
<div class="card shadow-sm mb-4">
  <table class="table table-bordered align-middle mb-0">
    <thead class="table-light">
      <tr class="fw-bold text-secondary">
        <th>
          {# Prepare params for case_number sorting link #}
          {% set new_params = (query_params or {}).copy() %}
          {% set _ = new_params.update({'sort_by': 'case_number', 'sort_order': 'asc' if sort_by != 'case_number' or sort_order == 'desc' else 'desc'}) %}
          <a href="{{ url_for(request.endpoint) -}}{{ query_string(new_params) }}">
            Boncszám
            {% if sort_by == 'case_number' %}
              {% if sort_order == 'asc' %}
                ▲
              {% else %}
                ▼
              {% endif %}
            {% endif %}
          </a>
        </th>
        <th>Elhunyt</th>
        <th>Típus</th>
        <th>Állapot</th>
        <th>Intézmény</th>
        <th>Regisztrálva</th>
        <th>
          {# Prepare params for deadline sorting link #}
          {% set new_params = (query_params or {}).copy() %}
          {% set _ = new_params.update({'sort_by': 'deadline', 'sort_order': 'asc' if sort_by != 'deadline' or sort_order == 'desc' else 'desc'}) %}
          <a href="{{ url_for(request.endpoint) -}}{{ query_string(new_params) }}">
            Határidő
            {% if sort_by == 'deadline' %}
              {% if sort_order == 'asc' %}
                ▲
              {% else %}
                ▼
              {% endif %}
            {% endif %}
          </a>
        </th>
        <th>Szakértő 1</th>
        <th>Szakértő 2</th>
        <th>Leíró</th>
        {% if show_actions %}
        <th>Részletek</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for case in cases %}
      <tr>

        <td>
          <a href="{{ url_for('auth.view_case', case_id=case.id) }}">{{ case.case_number }}</a>
        </td>
        <td>{{ case.deceased_name }}</td>
        <td>{{ case.case_type }}</td>
        <td>
          {{ case.status }}
        </td>
        <td>{{ case.institution_name }}</td>
        <td>{{ case.registration_time_str }}</td>
        <td>{{ case.formatted_deadline }}</td>
        <td>{{ _users_map[case.expert_1].screen_name if case.expert_1 in _users_map else case.expert_1 or '–' }}</td>
        <td>{{ _users_map[case.expert_2].screen_name if case.expert_2 in _users_map else case.expert_2 or '–' }}</td>
        <td>{{ _users_map[case.describer].screen_name if case.describer in _users_map else case.describer or '–' }}</td>
        {% if show_actions %}
        <td>
          {% if caps['can_edit_case'] %}
            <a href="{{ url_for('auth.edit_case', case_id=case.id) }}" class="btn btn-sm btn-primary">Szerkeszt</a>
          {% else %}
            <a href="{{ url_for('auth.view_case', case_id=case.id) }}" class="btn btn-sm btn-secondary">Megtekintés</a>
          {% endif %}
        </td>
        {% endif %}
      </tr>
      {% else %}
      <tr>
        <td colspan="{% if show_actions %}11{% else %}10{% endif %}" class="text-center">Nincs megjeleníthető ügy.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endmacro %}

{% macro dashboard_card(title, items=[], icon=None, icon_class='', empty_text='Nincs ilyen ügy.', link_view='auth.case_detail', value_format='%Y-%m-%d %H:%M') %}
<div class="card h-100 shadow-sm mb-3">
  <div class="card-header fw-bold">
    {% if icon %}
      <i class="{{ icon }} me-2 {{ icon_class }}"></i>
    {% endif %}
    {{ title }}
  </div>
  <div class="card-body p-0">
    <ul class="list-group list-group-flush">
      {% if items %}
        {% for item in items %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>
              {% if item.__class__.__name__ not in ['tuple', 'list'] %}
                <a href="{{ url_for(link_view, case_id=item.id) }}">{{ item.case_number }}</a>
              {% else %}
                {{ item[0] }}
              {% endif %}
            </span>
            <span>
              <strong>
                {% if item.__class__.__name__ not in ['tuple', 'list'] %}
                  {{ item.formatted_deadline if item.deadline else '' }}
                {% else %}
                  {{ item[1] }}
                {% endif %}
              </strong>
            </span>
          </li>
        {% endfor %}
      {% else %}
        <li class="list-group-item">{{ empty_text }}</li>
      {% endif %}
    </ul>
  </div>
</div>
{% endmacro %}

{% macro elvegzem_button(case, current_user) %}
  {% if current_user.role == 'szakértő' and case.expert_1 == current_user.screen_name %}
    <a href="{{ url_for('main.elvegzem', case_id=case.id) }}" class="btn btn-success ms-2">Elvégzem</a>
  {% elif current_user.role == 'leíró' %}
    {% set screen_name = (current_user.screen_name | default('', true)) | trim %}
    {% set username = (current_user.username | default('', true)) | trim %}
    {% set explicit_describer = (case.describer | default('', true)) | trim %}
    {% set fallback_describer = (effective_describer | default('', true)) | trim %}
    {% if (
      explicit_describer and (explicit_describer == screen_name or explicit_describer == username)
    ) or (
      fallback_describer and (fallback_describer == screen_name or fallback_describer == username)
    ) %}
      <a href="{{ url_for('main.elvegzem', case_id=case.id) }}" class="btn btn-success ms-2">Elvégzem</a>
    {% endif %}
  {% endif %}
{% endmacro %}
